<template>
  <el-form
    v-show="getShow"
    ref="formLogin"
    :model="loginData.loginForm"
    :rules="LoginRules"
    class="login-form"
    label-position="top"
    label-width="120px"
    size="large"
  >
    <el-row style="margin-right: -10px; margin-left: -10px">
      <!-- <el-col :span="24" style="padding-right: 10px; padding-left: 10px">
        <el-form-item>
          <LoginFormTitle style="width: 100%" />
        </el-form-item>
      </el-col> -->
      <el-col :span="24" style="padding-right: 10px; padding-left: 10px">
<!--        <el-form-item v-if="loginData.tenantEnable === 'true'" prop="tenantName">-->
<!--          <el-input-->
<!--            v-model="loginData.loginForm.tenantName"-->
<!--            :placeholder="t('login.tenantNamePlaceholder')"-->
<!--            :prefix-icon="iconHouse"-->
<!--            link-->
<!--            type="primary"-->
<!--          />-->
<!--        </el-form-item>-->
      </el-col>
      <el-col :span="24" style=" padding-left: 10px">
        <el-form-item prop="username" class="custom-form-item">
          <div class="icon-box">
            <component :is="iconAvatar" :size="28" />
          </div>
          <el-input
            v-model="loginData.loginForm.username"
            :placeholder="t('login.usernamePlaceholder')"
            class="rounded-input"
          />
        </el-form-item>
      </el-col>
      <el-col :span="24" style="padding-left: 10px">
        <el-form-item prop="password" class="custom-form-item">
          <div class="icon-box">
            <component :is="iconLock" :size="28" />
          </div>
          <el-input
            v-model="loginData.loginForm.password"
            :placeholder="t('login.passwordPlaceholder')"
            show-password
            type="password"
            class="rounded-input"
            @keyup.enter="getCode()"
          />
        </el-form-item>
      </el-col>
      <el-col
        :span="24"
        style="padding-right: 10px; padding-left: 10px; margin-top: -20px; margin-bottom: -20px"
      >
        <el-form-item>
          <el-row justify="space-between" style="width: 100%">
            <el-col :span="6">
              <el-checkbox v-model="loginData.loginForm.rememberMe">
                {{ t('login.remember') }}
              </el-checkbox>
            </el-col>
            <el-col :offset="6" :span="12">
              <el-link
                style="float: right; margin-left: 15px;"
                type="primary"
                @click="setLoginState(LoginStateEnum.RESET_PASSWORD)"
              >
                {{ t('login.forgetPassword') }}
              </el-link>

              <el-link
                style="float: right"
                type="primary"
                @click="setLoginState(LoginStateEnum.REGISTER)"
              >
                {{ t('login.btnRegister') }}
              </el-link>
            </el-col>
          </el-row>
        </el-form-item>
      </el-col>
      <el-col :span="24" style="padding-right: 10px; padding-left: 10px; margin-bottom: -20px">
        <el-form-item>
          <XButton
            :loading="loginLoading"
            :title="t('login.login')"
            class="w-[60%] mx-auto"
            type="primary"
            :round="true"
            @click="getCode()"
          />
        </el-form-item>
      </el-col>
      <Verify
        v-if="loginData.captchaEnable === 'true'"
        ref="verify"
        :captchaType="captchaType"
        :imgSize="{ width: '400px', height: '200px' }"
        mode="pop"
        @success="handleLogin"
      />
      <el-col :span="24" style="padding-right: 10px; padding-left: 10px;  margin-bottom: -20px">
        <el-divider>ÂÖ∂‰ªñÁôªÂΩïÊñπÂºè</el-divider>
        <el-form-item>
          <!-- <el-row :gutter="5" justify="space-between" style="width: 100%">
            <el-col :span="8">
              <XButton
                :title="t('login.btnMobile')"
                class="w-[100%]"
                @click="setLoginState(LoginStateEnum.MOBILE)"
              />
            </el-col>
            <el-col :span="8">
              <XButton
                :title="t('login.btnQRCode')"
                class="w-[100%]"
                @click="setLoginState(LoginStateEnum.QR_CODE)"
              />
            </el-col>
            <el-col :span="8">
              <XButton
                :title="t('login.btnRegister')"
                class="w-[100%]"
                @click="setLoginState(LoginStateEnum.REGISTER)"
              />
            </el-col>
          </el-row> -->
          <div class="social-login-container" style="margin-top: -5px">
            <div class="social-icon" @click="handleSocialLogin('ÂæÆ‰ø°')">
              <img src="@/assets/svgs/wechat.svg" alt="ÂæÆ‰ø°" width="30" height="30" />
            </div>
            <div class="social-icon" @click="handleSocialLogin('ÈíâÈíâ')">
              <img src="@/assets/svgs/dingtalk.svg" alt="ÈíâÈíâ" width="30" height="30" />
            </div>
            <div class="social-icon" @click="handleSocialLogin('Github')">
              <img src="@/assets/svgs/github.svg" alt="Github" width="30" height="30" />
            </div>
            <div class="social-icon" @click="handleSocialLogin('ÊîØ‰ªòÂÆù')">
              <img src="@/assets/svgs/alipay.svg" alt="ÊîØ‰ªòÂÆù" width="30" height="30" />
            </div>
          </div>
        </el-form-item>
      </el-col>
      <!-- <el-divider content-position="center">{{ t('login.otherLogin') }}</el-divider>
      <el-col :span="24" style="padding-right: 10px; padding-left: 10px">
        <el-form-item>
          <div class="w-[100%] flex justify-between">
            <Icon
              v-for="(item, key) in socialList"
              :key="key"
              :icon="item.icon"
              :size="30"
              class="anticon cursor-pointer"
              color="#999"
              @click="doSocialLogin(item.type)"
            />
          </div>
        </el-form-item>
      </el-col> -->
<!--      <el-divider content-position="center">ËêåÊñ∞ÂøÖËØª</el-divider>-->
<!--      <el-col :span="24" style="padding-right: 10px; padding-left: 10px">-->
<!--        <el-form-item>-->
<!--          <div class="w-[100%] flex justify-between">-->
<!--            <el-link href="https://doc.iocoder.cn/" target="_blank">üìöÂºÄÂèëÊåáÂçó</el-link>-->
<!--            <el-link href="https://doc.iocoder.cn/video/" target="_blank">üî•ËßÜÈ¢ëÊïôÁ®ã</el-link>-->
<!--            <el-link href="https://www.iocoder.cn/Interview/good-collection/" target="_blank">-->
<!--              ‚ö°Èù¢ËØïÊâãÂÜå-->
<!--            </el-link>-->
<!--            <el-link href="http://static.yudao.iocoder.cn/mp/Aix9975.jpeg" target="_blank">-->
<!--              ü§ùÂ§ñÂåÖÂí®ËØ¢-->
<!--            </el-link>-->
<!--          </div>-->
<!--        </el-form-item>-->
<!--      </el-col>-->
    </el-row>
  </el-form>
</template>
<script lang="ts" setup>
import { ElLoading } from 'element-plus'
import LoginFormTitle from './LoginFormTitle.vue'
import type { RouteLocationNormalizedLoaded } from 'vue-router'

import { useIcon } from '@/hooks/web/useIcon'

import * as authUtil from '@/utils/auth'
import * as LoginApi from '@/api/login'
import { LoginStateEnum, useFormValid, useLoginState } from './useLogin'
import { getUserSetting } from '@/api/system/user/setting'
import { useAppStore } from '@/store/modules/app'

defineOptions({ name: 'LoginForm' })

const { t } = useI18n()
const message = useMessage()
const iconHouse = useIcon({ icon: 'ep:house' })
const iconAvatar = useIcon({ icon: 'ep:avatar' })
const iconLock = useIcon({ icon: 'ep:lock' })
const formLogin = ref()
const { validForm } = useFormValid(formLogin)
const { setLoginState, getLoginState } = useLoginState()
const { currentRoute, push } = useRouter()
const redirect = ref<string>('')
const loginLoading = ref(false)
const verify = ref()
const captchaType = ref('blockPuzzle') // blockPuzzle ÊªëÂùó clickWord ÁÇπÂáªÊñáÂ≠ó

const getShow = computed(() => unref(getLoginState) === LoginStateEnum.LOGIN)

const LoginRules = {
  tenantName: [required],
  username: [required],
  password: [required]
}
const loginData = reactive({
  isShowPassword: false,
  captchaEnable: import.meta.env.VITE_APP_CAPTCHA_ENABLE,
  tenantEnable: import.meta.env.VITE_APP_TENANT_ENABLE,
  loginForm: {
    tenantName: import.meta.env.VITE_APP_DEFAULT_LOGIN_TENANT || '',
    username: import.meta.env.VITE_APP_DEFAULT_LOGIN_USERNAME || '',
    password: import.meta.env.VITE_APP_DEFAULT_LOGIN_PASSWORD || '',
    captchaVerification: '',
    rememberMe: true // ÈªòËÆ§ËÆ∞ÂΩïÊàë„ÄÇÂ¶ÇÊûú‰∏çÈúÄË¶ÅÔºåÂèØÊâãÂä®‰øÆÊîπ
  }
})

const socialList = [
  { icon: 'ant-design:wechat-filled', type: 30 },
  { icon: 'ant-design:dingtalk-circle-filled', type: 20 },
  { icon: 'ant-design:github-filled', type: 0 },
  { icon: 'ant-design:alipay-circle-filled', type: 0 }
]

// Ëé∑ÂèñÈ™åËØÅÁ†Å
const getCode = async () => {
  // ÊÉÖÂÜµ‰∏ÄÔºåÊú™ÂºÄÂêØÔºöÂàôÁõ¥Êé•ÁôªÂΩï
  if (loginData.captchaEnable === 'false') {
    await handleLogin({})
  } else {
    // ÊÉÖÂÜµ‰∫åÔºåÂ∑≤ÂºÄÂêØÔºöÂàôÂ±ïÁ§∫È™åËØÅÁ†ÅÔºõÂè™ÊúâÂÆåÊàêÈ™åËØÅÁ†ÅÁöÑÊÉÖÂÜµÔºåÊâçËøõË°åÁôªÂΩï
    // ÂºπÂá∫È™åËØÅÁ†Å
    verify.value.show()
  }
}
// // Ëé∑ÂèñÁßüÊà∑ ID
// const getTenantId = async () => {
//   if (loginData.tenantEnable === 'true') {
//     const res = await LoginApi.getTenantIdByName(loginData.loginForm.tenantName)
//     authUtil.setTenantId(res)
//   }
// }
// ËÆ∞‰ΩèÊàë
const getLoginFormCache = () => {
  const loginForm = authUtil.getLoginForm()
  if (loginForm) {
    loginData.loginForm = {
      ...loginData.loginForm,
      username: loginForm.username ? loginForm.username : loginData.loginForm.username,
      password: loginForm.password ? loginForm.password : loginData.loginForm.password,
      rememberMe: loginForm.rememberMe,
      tenantName: loginForm.tenantName ? loginForm.tenantName : loginData.loginForm.tenantName
    }
  }
}
// // Ê†πÊçÆÂüüÂêçÔºåËé∑ÂæóÁßüÊà∑‰ø°ÊÅØ
// const getTenantByWebsite = async () => {
//   const website = location.host
//   const res = await LoginApi.getTenantByWebsite(website)
//   if (res) {
//     loginData.loginForm.tenantName = res.name
//     authUtil.setTenantId(res.id)
//   }
// }
const loading = ref() // ElLoading.service ËøîÂõûÁöÑÂÆû‰æã
// ÁôªÂΩï
const handleLogin = async (params: any) => {
  loginLoading.value = true
  try {
    //await getTenantId()
    const data = await validForm()
    if (!data) {
      return
    }
    const loginDataLoginForm = { ...loginData.loginForm }
    loginDataLoginForm.captchaVerification = params.captchaVerification
    const res = await LoginApi.login(loginDataLoginForm)
    if (!res) {
      return
    }
    loading.value = ElLoading.service({
      lock: true,
      text: 'Ê≠£Âú®Âä†ËΩΩÁ≥ªÁªü‰∏≠...',
      background: 'rgba(0, 0, 0, 0.7)'
    })
    if (loginDataLoginForm.rememberMe) {
      authUtil.setLoginForm(loginDataLoginForm)
    } else {
      authUtil.removeLoginForm()
    }
    authUtil.setToken(res)
    
    // Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆÂπ∂ÂêåÊ≠•Âà∞ appStore
    try {
      const appStore = useAppStore()
      const userSettings = await getUserSetting()
      if (userSettings) {
        // ÂêåÊ≠•Âç°ÁâáËÆæÁΩÆ
        if (userSettings.cardConfig) {
          try {
            // Â∞ÜÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÁöÑÂç°ÁâáÈÖçÁΩÆËß£Êûê‰∏∫ÂØπË±°
            const cardSettings = JSON.parse(userSettings.cardConfig)
            // ËÆæÁΩÆÂà∞ appStore
            appStore.setCardSettings(cardSettings)
          } catch (parseError) {
            console.error('Ëß£ÊûêÂç°ÁâáÈÖçÁΩÆÂ§±Ë¥•:', parseError)
          }
        }
        // // ÂêåÊ≠•‰∏ªÈ¢òËÆæÁΩÆ
        // if (userSettings.data.theme) {
        //   appStore.setTheme(userSettings.data.theme)
        //   appStore.setCssVarTheme()
        // }
        // // ÂêåÊ≠•Â∏ÉÂ±ÄËÆæÁΩÆ
        // if (userSettings.data.layout) {
        //   appStore.setLayout(userSettings.data.layout)
        // }
      }
    } catch (error) {
      console.error('Ëé∑ÂèñÁî®Êà∑ËÆæÁΩÆÂ§±Ë¥•:', error)
      // Ëé∑ÂèñËÆæÁΩÆÂ§±Ë¥•‰∏çÂΩ±ÂìçÁôªÂΩïÊµÅÁ®ãÔºå‰ΩøÁî®ÈªòËÆ§ËÆæÁΩÆ
    }
    
    if (!redirect.value) {
      redirect.value = '/'
    }
    // Âà§Êñ≠ÊòØÂê¶‰∏∫SSOÁôªÂΩï
    if (redirect.value.indexOf('sso') !== -1) {
      window.location.href = window.location.href.replace('/login?redirect=', '')
    } else {
      // Âº∫Âà∂Ë∑≥ËΩ¨Âà∞È¶ñÈ°µÂπ∂Âà∑Êñ∞È°µÈù¢
      redirect.value = '/'
      await push({ path: '/' })
      // Ë∑≥ËΩ¨ÂÆåÊàêÂêéÂà∑Êñ∞È°µÈù¢
      setTimeout(() => {
        window.location.reload()
      }, 100)
    }
  } finally {
    loginLoading.value = false
    loading.value?.close()
  }
}
// Á§æ‰∫§ÁôªÂΩï
const doSocialLogin = async (type: number) => {
  if (type === 0) {
    message.error('Ê≠§ÊñπÂºèÊú™ÈÖçÁΩÆ')
  } else {
    loginLoading.value = true
    if (loginData.tenantEnable === 'true') {
      // Â∞ùËØïÂÖàÈÄöËøá tenantName Ëé∑ÂèñÁßüÊà∑
      //await getTenantId()
      // Â¶ÇÊûúËé∑Âèñ‰∏çÂà∞ÔºåÂàôÈúÄË¶ÅÂºπÂá∫ÊèêÁ§∫ÔºåËøõË°åÂ§ÑÁêÜ
      if (!authUtil.getTenantId()) {
        try {
          const data = await message.prompt('ËØ∑ËæìÂÖ•ÁßüÊà∑ÂêçÁß∞', t('common.reminder'))
          if (data?.action !== 'confirm') throw 'cancel'
          const res = await LoginApi.getTenantIdByName(data.value)
          authUtil.setTenantId(res)
        } catch (error) {
          if (error === 'cancel') return
        } finally {
          loginLoading.value = false
        }
      }
    }
    // ËÆ°ÁÆó redirectUri
    // Ê≥®ÊÑè: type„ÄÅredirect ÈúÄË¶ÅÂÖà encode ‰∏ÄÊ¨°ÔºåÂê¶ÂàôÈíâÈíâÂõûË∞É‰ºö‰∏¢Â§±„ÄÇ
    // ÈÖçÂêà social-login.vue#getUrlValue() ‰ΩøÁî®
    const redirectUri =
      location.origin +
      '/social-login?' +
      encodeURIComponent(`type=${type}&redirect=${redirect.value || '/'}`)

    // ËøõË°åË∑≥ËΩ¨
    window.location.href = await LoginApi.socialAuthRedirect(type, encodeURIComponent(redirectUri))
  }
}
const handleSocialLogin = (platform) => {
  ElMessage.info(`‰ΩøÁî®${platform}ÁôªÂΩï`)
}
watch(
  () => currentRoute.value,
  (route: RouteLocationNormalizedLoaded) => {
    redirect.value = route?.query?.redirect as string
  },
  {
    immediate: true
  }
)
onMounted(() => {
  getLoginFormCache()
  //getTenantByWebsite()
})
</script>

<style lang="scss" scoped>
:deep(.anticon) {
  &:hover {
    color: var(--login-primary-color) !important;
  }
}

/* Ëá™ÂÆö‰πâË°®ÂçïÈ°πÊ†∑ÂºèÔºåÁî®‰∫éÂ§ñÁΩÆÂõæÊ†á */
.custom-form-item {
  position: relative;
  padding-left: 40px; /* Â¢ûÂä†ÂõæÊ†áÈ¢ÑÁïôÁ©∫Èó¥ */
  
  .icon-box {
    position: absolute;
    left: -40px; /* Â∞ÜÂõæÊ†áÂæÄÂ∑¶ÁßªÂä® */
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    color: #909399;
    z-index: 1;
  }
  
  /* ÂúÜËßíËæìÂÖ•Ê°ÜÊ†∑Âºè */
  .rounded-input {
    width: 90%; /* Ë∞ÉÊï¥ËæìÂÖ•Ê°ÜÈïøÂ∫¶ */
    :deep(.el-input__wrapper) {
      border-radius: 20px;
    }
  }
}

.login-code {
  float: right;
  width: 100%;
  height: 38px;

  img {
    width: 100%;
    height: auto;
    max-width: 100px;
    vertical-align: middle;
    cursor: pointer;
  }
}
.social-login-container {
  display: flex;
  justify-content: space-around;
  align-items: center;
  width: 100%;
  margin-top: 10px;
}

.social-icon {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background-color: #f5f7fa;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  
  &:hover {
    background-color: var(--login-primary-color);
    color: white;
    transform: translateY(-2px);
  }
}

.social-icon:nth-child(1):hover {
  background-color: #07c160;
}

.social-icon:nth-child(2):hover {
  background-color: #12b7f5;
}

.social-icon:nth-child(3):hover {
  background-color: #333;
}

.social-icon:nth-child(4):hover {
  background-color: var(--login-primary-color);
}
</style>
